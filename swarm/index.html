<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Swarm Life Map</title>
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #fff;
      height: 100dvh;
      overflow: hidden;
    }

    #map { position: absolute; inset: 0; }

    /* ── Title ── */
    #title-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(10,10,10,0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px 18px;
      z-index: 10;
      min-width: 200px;
    }
    #title-panel h1 {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.3px;
      line-height: 1.2;
    }
    #title-panel .subtitle {
      font-size: 12px;
      color: rgba(255,255,255,0.45);
      margin-top: 5px;
      line-height: 1.4;
    }

    /* ── Ghost year watermark ── */
    #year-ghost {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(80px, 18vw, 160px);
      font-weight: 800;
      color: rgba(255,255,255,0.04);
      pointer-events: none;
      letter-spacing: -4px;
      user-select: none;
      z-index: 5;
      transition: opacity 0.3s;
    }

    /* ── Controls panel ── */
    #controls {
      position: absolute;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      width: min(580px, calc(100vw - 32px));
      background: rgba(10,10,10,0.82);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 18px 22px 16px;
      z-index: 10;
    }

    #controls-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 14px;
    }
    #year-label {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -1px;
      color: #ff6b35;
      min-width: 80px;
    }
    #checkin-count {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      text-align: right;
    }
    #checkin-count strong {
      color: rgba(255,255,255,0.85);
      font-weight: 600;
    }

    /* Mode tabs */
    .tab-group {
      display: flex;
      gap: 5px;
      margin-bottom: 14px;
    }
    .tab {
      padding: 5px 13px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.2px;
    }
    .tab:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
    .tab.active {
      background: rgba(255,107,53,0.15);
      border-color: rgba(255,107,53,0.4);
      color: #ff6b35;
    }

    /* Slider row */
    #slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .year-bound {
      font-size: 11px;
      color: rgba(255,255,255,0.3);
      min-width: 30px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    #year-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 3px;
      border-radius: 2px;
      background: rgba(255,255,255,0.12);
      outline: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #year-slider.disabled { opacity: 0.3; pointer-events: none; }
    #year-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ff6b35;
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(255,107,53,0.25), 0 2px 8px rgba(255,107,53,0.5);
      transition: box-shadow 0.15s;
    }
    #year-slider::-webkit-slider-thumb:hover {
      box-shadow: 0 0 0 5px rgba(255,107,53,0.2), 0 2px 12px rgba(255,107,53,0.6);
    }
    #play-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: #ff6b35;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 16px rgba(255,107,53,0.45);
      transition: transform 0.15s, box-shadow 0.15s;
      flex-shrink: 0;
      line-height: 1;
    }
    #play-btn:hover { transform: scale(1.08); box-shadow: 0 0 22px rgba(255,107,53,0.6); }
    #play-btn.disabled { opacity: 0.4; pointer-events: none; }

    /* ── Legend ── */
    #legend {
      position: absolute;
      bottom: 28px;
      right: 20px;
      background: rgba(10,10,10,0.75);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 11px 14px;
      z-index: 10;
    }
    #legend h3 {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: rgba(255,255,255,0.35);
      margin-bottom: 7px;
    }
    .legend-bar {
      width: 110px;
      height: 7px;
      border-radius: 4px;
      background: linear-gradient(
        to right,
        rgba(33,102,172,0.7),
        rgba(0,200,160,0.9),
        rgba(200,220,0,1),
        rgba(255,100,0,1),
        rgba(255,0,0,1)
      );
    }
    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: rgba(255,255,255,0.3);
      margin-top: 4px;
    }

    /* ── Tooltip ── */
    #tooltip {
      position: absolute;
      background: rgba(10,10,10,0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 9px 13px;
      font-size: 13px;
      pointer-events: none;
      z-index: 20;
      max-width: 220px;
      display: none;
      line-height: 1.4;
    }
    #tooltip .venue { font-weight: 600; }
    #tooltip .date { font-size: 11px; color: rgba(255,255,255,0.45); margin-top: 2px; }

    /* Loading overlay */
    #loading {
      position: absolute;
      inset: 0;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      gap: 16px;
      transition: opacity 0.5s;
    }
    #loading.fade-out { opacity: 0; pointer-events: none; }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(255,107,53,0.2);
      border-top-color: #ff6b35;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading p { font-size: 14px; color: rgba(255,255,255,0.5); }
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p>Loading your check-in history…</p>
</div>

<div id="map"></div>

<div id="title-panel">
  <h1>Swarm Life Map</h1>
  <p class="subtitle" id="total-label">Loading…</p>
</div>

<div id="year-ghost">ALL</div>

<div id="controls">
  <div id="controls-header">
    <div id="year-label">All Years</div>
    <div id="checkin-count"></div>
  </div>

  <div class="tab-group">
    <button class="tab active" data-mode="all">All years</button>
    <button class="tab" data-mode="single">Single year</button>
    <button class="tab" data-mode="up-to">Up to year</button>
  </div>

  <div id="slider-row">
    <button id="play-btn" class="disabled" title="Play through years">▶</button>
    <span class="year-bound" id="min-year">–</span>
    <input type="range" id="year-slider" class="disabled" min="2012" max="2026" value="2019" step="1">
    <span class="year-bound" id="max-year">–</span>
  </div>
</div>

<div id="legend">
  <h3>Check-in density</h3>
  <div class="legend-bar"></div>
  <div class="legend-labels"><span>Low</span><span>High</span></div>
</div>

<div id="tooltip"></div>

<script>
(async () => {
  // ── State ──────────────────────────────────────────────────────────────────
  let allData = null;
  let currentMode = 'all';   // 'all' | 'single' | 'up-to'
  let currentYear = 2019;
  let playTimer = null;
  let minYear, maxYear;
  const yearCounts = {};

  // ── Map ────────────────────────────────────────────────────────────────────
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'carto-dark': {
          type: 'raster',
          tiles: [
            'https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}@2x.png',
            'https://b.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}@2x.png',
            'https://c.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}@2x.png',
          ],
          tileSize: 256,
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>',
        },
      },
      layers: [{ id: 'background', type: 'raster', source: 'carto-dark' }],
    },
    center: [0, 25],
    zoom: 1.8,
    attributionControl: { compact: true },
  });

  // ── Load data ──────────────────────────────────────────────────────────────
  let geojson;
  try {
    const resp = await fetch('data.json');
    if (!resp.ok) throw new Error(resp.statusText);
    geojson = await resp.json();
  } catch (e) {
    document.querySelector('#loading p').textContent =
      'Could not load swarm-data.json — run process-swarm.js first.';
    return;
  }

  // Filter out any features with invalid coordinates
  geojson.features = geojson.features.filter(f => {
    const [lng, lat] = f.geometry.coordinates;
    return lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
  });
  allData = geojson;

  // Compute year range and per-year counts
  for (const f of geojson.features) {
    const y = f.properties.y;
    yearCounts[y] = (yearCounts[y] || 0) + 1;
  }
  const years = Object.keys(yearCounts).map(Number).sort((a, b) => a - b);
  minYear = years[0];
  maxYear = years[years.length - 1];
  currentYear = maxYear;

  // Update slider bounds
  const slider = document.getElementById('year-slider');
  slider.min = minYear;
  slider.max = maxYear;
  slider.value = currentYear;
  document.getElementById('min-year').textContent = minYear;
  document.getElementById('max-year').textContent = maxYear;

  // Subtitle
  document.getElementById('total-label').textContent =
    `${geojson.features.length.toLocaleString()} check-ins · ${minYear}–${maxYear}`;

  // ── Wait for map style, then add layers ───────────────────────────────────
  await new Promise(r => map.on('load', r));

  map.addSource('checkins', { type: 'geojson', data: geojson });

  // Heatmap layer (visible at all zoom levels, fades at high zoom)
  map.addLayer({
    id: 'heatmap',
    type: 'heatmap',
    source: 'checkins',
    maxzoom: 17,
    paint: {
      'heatmap-weight': 1,
      'heatmap-intensity': [
        'interpolate', ['linear'], ['zoom'],
        0, 0.8,
        9, 2.5,
      ],
      'heatmap-color': [
        'interpolate', ['linear'], ['heatmap-density'],
        0,   'rgba(33,102,172,0)',
        0.1, 'rgba(33,102,172,0.6)',
        0.3, 'rgba(0,190,150,0.8)',
        0.5, 'rgba(200,230,0,0.9)',
        0.75,'rgba(255,110,0,1)',
        1,   'rgba(255,20,0,1)',
      ],
      'heatmap-radius': [
        'interpolate', ['linear'], ['zoom'],
        0, 3,
        6, 12,
        11, 22,
      ],
      'heatmap-opacity': [
        'interpolate', ['linear'], ['zoom'],
        13, 0.85,
        16, 0.2,
      ],
    },
  });

  // Individual point layer (visible when zoomed in)
  map.addLayer({
    id: 'points',
    type: 'circle',
    source: 'checkins',
    minzoom: 12,
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        12, 2.5,
        17, 7,
      ],
      'circle-color': '#ff6b35',
      'circle-opacity': [
        'interpolate', ['linear'], ['zoom'],
        12, 0,
        14, 0.75,
      ],
      'circle-stroke-width': 1,
      'circle-stroke-color': 'rgba(255,255,255,0.15)',
    },
  });

  // ── Fit bounds to data ────────────────────────────────────────────────────
  let west = Infinity, east = -Infinity, south = Infinity, north = -Infinity;
  for (const f of geojson.features) {
    const [lng, lat] = f.geometry.coordinates;
    if (lng < west) west = lng;
    if (lng > east) east = lng;
    if (lat < south) south = lat;
    if (lat > north) north = lat;
  }
  map.fitBounds([[west, south], [east, north]], { padding: 60, duration: 1200 });

  // ── Enable controls ───────────────────────────────────────────────────────
  slider.classList.remove('disabled');
  document.getElementById('play-btn').classList.remove('disabled');

  // Hide loading screen
  const loading = document.getElementById('loading');
  loading.classList.add('fade-out');
  setTimeout(() => loading.remove(), 600);

  // ── Render helpers ────────────────────────────────────────────────────────
  function getFilter() {
    if (currentMode === 'all') return null;
    if (currentMode === 'single') return ['==', ['get', 'y'], currentYear];
    if (currentMode === 'up-to')  return ['<=', ['get', 'y'], currentYear];
  }

  function getCount() {
    if (currentMode === 'all') return geojson.features.length;
    if (currentMode === 'single') return yearCounts[currentYear] || 0;
    if (currentMode === 'up-to') {
      return years.filter(y => y <= currentYear).reduce((s, y) => s + (yearCounts[y] || 0), 0);
    }
  }

  function render() {
    const filter = getFilter();
    map.setFilter('heatmap', filter);
    map.setFilter('points', filter);

    const count = getCount();
    const isAll = currentMode === 'all';
    const label = isAll ? 'All Years' : String(currentYear);
    const ghost = isAll ? 'ALL' : String(currentYear);

    document.getElementById('year-label').textContent = label;
    document.getElementById('year-ghost').textContent = ghost;
    document.getElementById('checkin-count').innerHTML =
      `<strong>${count.toLocaleString()}</strong> check-ins`;

    // Slider fill
    const pct = ((currentYear - minYear) / (maxYear - minYear)) * 100;
    slider.style.background =
      `linear-gradient(to right, #ff6b35 ${pct}%, rgba(255,255,255,0.12) ${pct}%)`;
  }

  render();

  // ── Mode tabs ─────────────────────────────────────────────────────────────
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      stopPlay();
      currentMode = tab.dataset.mode;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const sliderDisabled = currentMode === 'all';
      slider.classList.toggle('disabled', sliderDisabled);
      document.getElementById('play-btn').classList.toggle('disabled', sliderDisabled);

      render();
    });
  });

  // ── Slider ────────────────────────────────────────────────────────────────
  slider.addEventListener('input', () => {
    currentYear = parseInt(slider.value);
    render();
  });

  // ── Play / pause ──────────────────────────────────────────────────────────
  const playBtn = document.getElementById('play-btn');

  function stopPlay() {
    if (playTimer) { clearInterval(playTimer); playTimer = null; }
    playBtn.textContent = '▶';
  }

  function startPlay() {
    if (currentMode === 'all') {
      currentMode = 'single';
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.mode === 'single');
      });
      slider.classList.remove('disabled');
    }

    if (currentYear >= maxYear) {
      currentYear = minYear;
      slider.value = currentYear;
    }

    playBtn.textContent = '⏸';
    playTimer = setInterval(() => {
      currentYear++;
      slider.value = currentYear;
      render();
      if (currentYear >= maxYear) stopPlay();
    }, 1000);
    render();
  }

  playBtn.addEventListener('click', () => {
    if (playTimer) { stopPlay(); } else { startPlay(); }
  });

  // ── Tooltip on zoomed-in points ───────────────────────────────────────────
  const tooltip = document.getElementById('tooltip');

  map.on('mouseenter', 'points', () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'points', () => {
    map.getCanvas().style.cursor = '';
    tooltip.style.display = 'none';
  });
  map.on('mousemove', 'points', e => {
    const f = e.features[0];
    if (!f) return;
    const { v: venue, y: year, m: month } = f.properties;
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    tooltip.innerHTML =
      `<div class="venue">${venue || 'Unknown venue'}</div>` +
      `<div class="date">${monthNames[month - 1]} ${year}</div>`;
    tooltip.style.display = 'block';
    tooltip.style.left = (e.point.x + 14) + 'px';
    tooltip.style.top  = (e.point.y - 10) + 'px';
  });

})();
</script>
</body>
</html>
